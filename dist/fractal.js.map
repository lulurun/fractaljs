{"version":3,"file":"fractal.js","sources":["../src/pubsub.js","../src/component.js","../src/index.js"],"sourcesContent":["let topics = {}, seq = 0;\n\nexport default {\n  publish: function(topic, data, publisher) {\n    console.debug(\"publish\", topic);\n    let subscribers = topics[topic];\n    for (let i in subscribers)\n      subscribers[i].cb(topic, data, publisher);\n  },\n  subscribe: function(topic, cb, subscriber) {\n    console.debug(\"subscribe\", topic);\n    if (!topics[topic])\n      topics[topic] = [];\n    let token = ++seq;\n    topics[topic].push({\n      token: token,\n      subscriber: subscriber,\n      cb: cb\n    });\n    return token;\n  },\n  unsubscribe: function(topic, token) {\n    console.debug(\"unsubscribe\", topic);\n    if (!(topic in topics))\n      return;\n    let subscribers = topics[topic];\n    for (let i in subscribers) {\n      if (subscribers[i].token === token) {\n        subscribers.splice(i, 1);\n        break;\n      }\n    }\n    if (subscribers.length === 0)\n      delete topics[topic];\n  },\n  getSubscribers: function(topic) {\n    if (!(topic in topics))\n      return [];\n    return topics[topic].map(v => { return v.subscriber; });\n  },\n};\n","import Pubsub from './pubsub'\n\nconst COMPONENT_ATTR = 'f-component'\nconst knownComponents = {}\n\nexport class Component {\n  constructor(name, el, parent) {\n    this.name = name;\n    this.el = el;\n    this.complete = false;\n    this.parent = parent;\n    this.children = [];\n    this.subTokens = {};\n  }\n\n  getData(cb, param) {\n    cb(this.data || {});\n  }\n\n  render(data, template, cb, param) {\n    this.el.innerHTML = template(data);\n    cb();\n  }\n\n  loadChildren(cb, param) {\n    const els = this.el.querySelectorAll('[' + COMPONENT_ATTR + ']');\n    if (!els || !els.length) {\n      if (cb) cb();\n      return;\n    }\n\n    const len = els.length;\n    let nbComplete = 0;\n    Array.prototype.forEach.call(els, (el, i) => {\n      const name = el.getAttribute(COMPONENT_ATTR);\n      console.log(\"load component:\", name);\n      const Class = knownComponents[name];\n      const c = new Class(name, el, this);\n      this.children.push(c);\n      c.load(param, () => {\n        if (++nbComplete === len) {\n          if (cb) cb();\n        }\n      });\n    });\n  }\n\n  destroyed(param) {\n    this.children.forEach(c => {\n      c.destroyed(param);\n    });\n    this.children = [];\n    console.debug(this.name, \"destroyed\");\n    for (let topic in this.subTokens)\n      Pubsub.unsubscribe(this.subTokens[topic]);\n  }\n\n  rendered(cb, param) {\n    if (cb) cb();\n  }\n  loaded(param){}\n\n  load(param, cb) {\n    param = param || {};\n    console.time('Component.' + this.name);\n    this.complete = false;\n    this.getData(data => {\n      console.log(this.name, data);\n      this.render(data, this.template, () => {\n        this.children.forEach(c => {\n          c.destroyed(param);\n        });\n        this.children = [];\n        this.rendered(() => {\n          this.loadChildren(() => {\n            this.complete = true;\n            console.timeEnd('Component.' + this.name);\n            this.loaded(param);\n            if (cb) cb();\n          }, param)\n        }, param);\n      }, param);\n    }, param)\n  }\n\n  publish(topic, data) {\n    Pubsub.publish(topic, data, this);\n  }\n\n  subscribe(topic, cb) {\n    this.subTokens[topic] = Pubsub.subscribe(topic, cb, this);\n  }\n}\n\nclass Root extends Component {\n  constructor(el) {\n    super('', el, null);\n  }\n}\n\nexport function build(el, param) {\n  const root = new Root(el);\n  root.loadChildren(() => {}, param);\n}\n\nexport function createComponent(name, def, base) {\n  const baseClass = base ? knownComponents[base] : Component;\n  const c = class extends baseClass {\n    constructor(name, el, parent) {\n      super(name, el, parent);\n      for (const k in def) {\n        if (k === 'init') continue;\n        if (typeof def[k] === 'function') {\n          this[k] = def[k].bind(this);\n        } else {\n          this[k] = def[k];\n        }\n      }\n      if (def.init) def.init.bind(this)();\n    }\n  };\n  knownComponents[name] = c;\n  return c;\n}\n","import {Component, build, createComponent} from './component'\nimport Pubsub from './pubsub'\n\nwindow.onpopstate = function () {\n  Pubsub.publish(\"onpopstate\", location.hash);\n};\n\nexport default {\n  build: build,\n  component: createComponent,\n  Component: Component,\n}\n"],"names":["topics","seq","topic","data","publisher","debug","subscribers","i","cb","subscriber","token","push","splice","length","map","v","COMPONENT_ATTR","knownComponents","Component","name","el","parent","complete","children","subTokens","param","template","innerHTML","els","querySelectorAll","len","nbComplete","prototype","forEach","call","getAttribute","log","Class","c","load","destroyed","unsubscribe","time","getData","render","rendered","loadChildren","timeEnd","loaded","publish","Pubsub","subscribe","Root","build","root","createComponent","def","base","baseClass","k","bind","init","window","onpopstate","location","hash"],"mappings":"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"}