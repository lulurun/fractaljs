{"version":3,"file":"fractal.js","sources":["../src/pubsub.js","../src/component.js","../src/index.js"],"sourcesContent":["let topics = {}, seq = 0;\n\nexport default {\n  publish: function(topic, data, publisher) {\n    console.debug(\"publish\", topic);\n    let subscribers = topics[topic];\n    for (let i in subscribers)\n      subscribers[i].cb(topic, data, publisher);\n  },\n  subscribe: function(topic, cb, subscriber) {\n    console.debug(\"subscribe\", topic);\n    if (!topics[topic])\n      topics[topic] = [];\n    let token = ++seq;\n    topics[topic].push({\n      token: token,\n      subscriber: subscriber,\n      cb: cb\n    });\n    return token;\n  },\n  unsubscribe: function(topic, token) {\n    console.debug(\"unsubscribe\", topic);\n    if (!(topic in topics))\n      return;\n    let subscribers = topics[topic];\n    for (let i in subscribers) {\n      if (subscribers[i].token === token) {\n        subscribers.splice(i, 1);\n        break;\n      }\n    }\n    if (subscribers.length === 0)\n      delete topics[topic];\n  },\n  getSubscribers: function(topic) {\n    if (!(topic in topics))\n      return [];\n    return topics[topic].map(v => { return v.subscriber; });\n  },\n};\n","import Pubsub from './pubsub'\n\nconst COMPONENT_ATTR = 'f-component'\nconst knownComponents = {}\n\nexport class Component {\n  constructor(name, el, parent) {\n    this.name = name;\n    this.el = el;\n    this.complete = false;\n    this.parent = parent;\n    this.children = [];\n    this.subTokens = {};\n  }\n\n  getData(cb, param) {\n    cb(this.data || {});\n  }\n\n  render(data, cb, param) {\n    this.el.innerHTML = this.template(data);\n    this.el.querySelectorAll('*[f-onclick]').forEach(n => {\n      n.onclick = () => {\n        let f = new Function('this.' + n.getAttribute('f-onclick'));\n        f.bind(this)();\n      }\n    });\n    cb();\n  }\n\n  addChild(name, el, cb, param) {\n    console.log(\"add child:\", name);\n    const Class = knownComponents[name];\n    const c = new Class(name, el, this);\n    this.children.push(c);\n    c.load(param, cb);\n  }\n\n  loadChildren(cb, param) {\n    const els = this.el.querySelectorAll('[' + COMPONENT_ATTR + ']');\n    if (!els || !els.length) {\n      if (cb) cb();\n      return;\n    }\n\n    const len = els.length;\n    let nbComplete = 0;\n    Array.prototype.forEach.call(els, (el, i) => {\n      const name = el.getAttribute(COMPONENT_ATTR);\n      this.addChild(name, el, () => {\n        if (++nbComplete === len) {\n          if (cb) cb();\n        }\n      });\n    });\n  }\n\n  destroyed(param) {\n    this.children.forEach(c => {\n      c.destroyed(param);\n    });\n    this.children = [];\n    console.debug(this.name, \"destroyed\");\n    for (let topic in this.subTokens)\n      Pubsub.unsubscribe(this.subTokens[topic]);\n  }\n\n  rendered(cb, param) {\n    if (cb) cb();\n  }\n  loaded(param){}\n\n  load(param, cb) {\n    param = param || {};\n    console.time('Component.' + this.name);\n    this.complete = false;\n    this.getData(data => {\n      this.render(data, () => {\n        this.children.forEach(c => {\n          c.destroyed(param);\n        });\n        this.children = [];\n        this.rendered(() => {\n          this.loadChildren(() => {\n            this.complete = true;\n            console.timeEnd('Component.' + this.name);\n            this.loaded(param);\n            if (cb) cb();\n          }, param)\n        }, param);\n      }, param);\n    }, param)\n  }\n\n  publish(topic, data) {\n    Pubsub.publish(topic, data, this);\n  }\n\n  subscribe(topic, cb) {\n    this.subTokens[topic] = Pubsub.subscribe(topic, cb, this);\n  }\n}\n\nclass Root extends Component {\n  constructor(el) {\n    super('', el, null);\n  }\n}\n\nexport function build(el, param) {\n  const root = new Root(el);\n  root.loadChildren(() => {}, param);\n}\n\nexport function createComponent(name, def, base) {\n  const baseClass = base ? knownComponents[base] : Component;\n  const c = class extends baseClass {\n    constructor(name, el, parent) {\n      super(name, el, parent);\n      for (const k in def) {\n        if (k === 'init') continue;\n        if (typeof def[k] === 'function') {\n          this[k] = def[k].bind(this);\n        } else {\n          this[k] = def[k];\n        }\n      }\n      if (def.init) def.init.bind(this)();\n    }\n  };\n  knownComponents[name] = c;\n  return c;\n}\n","import {Component, build, createComponent} from './component'\nimport Pubsub from './pubsub'\n\nwindow.onpopstate = function () {\n  Pubsub.publish(\"onpopstate\", location.hash);\n};\n\nexport default {\n  build: build,\n  component: createComponent,\n  Component: Component,\n}\n"],"names":["topics","seq","topic","data","publisher","debug","subscribers","i","cb","subscriber","token","push","splice","length","map","v","COMPONENT_ATTR","knownComponents","Component","name","el","parent","complete","children","subTokens","param","innerHTML","template","querySelectorAll","forEach","onclick","f","Function","n","getAttribute","bind","log","Class","c","load","els","len","nbComplete","prototype","call","addChild","destroyed","unsubscribe","time","getData","render","rendered","loadChildren","timeEnd","loaded","publish","Pubsub","subscribe","Root","build","root","createComponent","def","base","baseClass","k","init","window","onpopstate","location","hash"],"mappings":"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"}